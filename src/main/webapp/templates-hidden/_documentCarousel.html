<!DOCTYPE html>
<html>
<head>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type" />

    <title>Embedded Topbar template</title>
</head>

<!-- This is an embedded piece of html -->
<body class="lift:content_id=carousel">

    <!-- Footer -->
    <div id="carousel">
        <div class="controls">
            <a class="btn btn-success" id="text" style="display:none;">Full Text</a>
        </div>

        <div class="owl-carousel">
            <div class="row">
                <div id="bill-text" class="col-md-8">
                    <p class="lead" id="bill-title"></p>
                </div>
                <div id="bill-data" class="col-md-4"></div>
            </div>
            <div id="tree-container">
                <div id="layer-tree"></div>
                <div id="layer-info">
                    <div class="row">
                        <a id="edit-node" class="btn btn-primary">Edit</a>
                        <a class="btn btn-default">Share</a>
                        <div class="col-md-12" id="title">
                            <h4 name="header"></h4>
                            <p name="text"></p>
                        </div>
                    </div>
                    <div class="row">
                        <a class="btn btn-primary">Comment</a>
                        <div class="col-md-12" id="comments">
                            <div id="comment-id-root"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div data-lift="tail" id="generic-modal" class="modal fade" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">Modal title</h4>
                    </div>
                    <div class="modal-body"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" name="generic-save">Save changes</button>
                    </div>
                </div>
            </div>
        </div>

        <script data-lift="tail" type="x-template" id="edit-form">
            <div>
                <textarea class="form-control" rows="9"></textarea>
            </div>
        </script>

        <script data-lift="tail" type="text/javascript">
            var billID = "";

            function setCarouselHeight() {
                var height = $(window).height() - 273;
                $("body").prepend("<style>.owl-item.active { overflow: auto; height:" + height + "px; }</style>");
            };

            function addLayerToContainer(layer, parent) {
                var newLayer = $("<div/>").addClass("indent").addClass(layer.attributes.part_type);
                var head = $("<h5/>").addClass("header").text(layer.attributes.header);
                var text = $("<p/>").addClass("text").text(layer.attributes.text);

                var toAdd = [];

                if(layer.header) head.prepend($("<span/>").addClass("enum").text(layer.attributes.enum));
                else text.prepend($("<span/>").addClass("enum").text(layer.attributes.enum));

                if(layer.attributes.header) toAdd.push(head);
                if(layer.attributes.text) toAdd.push(text);

                newLayer.append(toAdd).append(layerBtnSet(layer));

                newLayer.on('mouseover', function(e){
                    e.stopPropagation();
                    $('.indent').removeClass('active');
                    $(this).addClass("active");
                });

                parent.append(newLayer);

                if(layer.attributes.children) {
                    layer.attributes.children.map(function( obj ){
                        addLayerToContainer( obj, newLayer );
                    });
                }
            };

            function layerBtnSet( layer ) {
                var container = $('<div/>').addClass('btn-set');
                var btn = $('<a class="btn btn-primary"><i class="glyphicon glyphicon-cog"></i></a>');

                container.append([ btn ]);

                btn.on('click', function(){
                    $('#layer-tree').empty();
                    $("#text").show();
                    setup_tree(billID, layer.id);
                    $('.owl-carousel').trigger('to.owl.carousel', [1, 250]);
                });

                return container;
            };

            $(document).ready(function(){
                $(".owl-carousel").owlCarousel({
                    items: 1,
                    mouseDrag: false,
                    touchDrag: false,
                    pullDrag: false,
                    dots: false
                });

                $("#move").on("click", function(){
                    $("#text").show();
                    $(".owl-carousel").trigger("to.owl.carousel", [1, 250]);
                });

                $("#text").on("click", function(){
                    $(this).hide();
                    $(".owl-carousel").trigger("to.owl.carousel", [0, 250]);
                });

                $("#edit-node").on("local.setupEdit", function( event, node ){
                    var modal = $("#generic-modal");
                    var template = $("#edit-form").html();

                    $(this).off("click").on("click", function(){
                        var body = modal.find(".modal-body");
                        var commitBtn = modal.find("[name='generic-save']");

                        body.empty().html(template);
                        body.find("textarea").text(node.details);
                        commitBtn.off("click");

                        commitBtn.on("click", function(){
                            modal.modal('hide');
                        });

                        modal.modal('show');
                    });
                });

                setCarouselHeight();

                var path = window.location.pathname;
                var match = path.match(/.+\/(.+?)$/);

                if(match.length > 1) {
                    billID = match[1];

                    var path = "/api/v1/bills/" + billID + "?include=parts";

                    $.ajax({
                        url: path,
                        method: "GET",
                        dataType: "json"
                    }).done(function( json ){
                        if(json.data) {
                            var attr = json.data.attributes;
                            var btn = $('<a class="btn btn-success" target="_blank" id="download">PDF Text</a>');
                            btn.attr('href', attr.pdf);

                            $('#bill-title').text(attr.official_title);
                            $('#bill-data').append(btn);

                            if(json.data.relationships) {
                                var container = $("#bill-text");

                                json.data.relationships.parts.map(function( obj ){
                                    addLayerToContainer( obj, container );
                                });
                            }
                        }
                    });
                }
            });
        </script>
    </div>

</body>