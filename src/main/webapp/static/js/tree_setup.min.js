$.widget("custom.tree",{_create:function(){var elem=this.element;this.elemid=elem.attr("id"),""==this.elemid&&(this.elemid="custom-tree-container",this.elem.attr("id",elemid)),this.margin=margin={top:20,right:120,bottom:20,left:120},this.width=width=elem.width()-margin.right-margin.left,this.height=height=800-margin.top-margin.bottom,this.i=0,this.duration=750,this.root,this.tree=d3.layout.tree().size([height,width]),this.diagonal=d3.svg.diagonal().projection(function(d){return[d.y,d.x]}),this.svg=d3.select("#"+this.elemid).append("svg").attr("width",width+margin.right+margin.left).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")")},loadPart:function(bill,part){var widget=this;this.bill=bill,this.part=part;var url="/api/v1/bills/"+this.bill+"/parts/"+this.part+"?include=nodes";$.ajax({url:url,method:"GET",dataType:"json"}).done(function(json){function collapse(d){d.children&&d.children.length>0&&(d._children=d.children,d._children.forEach(collapse),d.children=null)}json.data&&json.data.relationships.nodes&&json.data.relationships.nodes.length>0&&(root=json.data.relationships.nodes[0],root.x0=height/2,root.y0=0,root.children&&root.children.forEach(collapse),widget.root=root,widget.update(widget.root),widget._setupNodeInfo(widget.root))}).fail(function(){})},update:function(source){var widget=this,svg=this.svg,tree=this.tree,duration=this.duration,diagonal=this.diagonal,nodes=tree.nodes(this.root).reverse(),links=tree.links(nodes);nodes.forEach(function(d){d.y=180*d.depth});var node=svg.selectAll("g.node").data(nodes,function(d){return d.id||(d.id=++i)}),nodeEnter=node.enter().append("g").attr("id",function(d){return d.id}).attr("class","node").attr("transform",function(d){return"translate("+source.y0+","+source.x0+")"}).on("click",this.click.bind(this));nodeEnter.append("circle").attr("r",1e-6).style("fill",function(d){return d._children?"lightsteelblue":"#fff"}),nodeEnter.append("text").attr("x",function(d){return d.children||d._children?-10:10}).attr("dy",".35em").attr("text-anchor",function(d){return d.children||d._children?"end":"start"}).text(function(d){return d.id}).style("fill-opacity",1e-6);var nodeUpdate=node.transition().duration(duration).attr("class",function(d){return d.id==source.id?"node temp":"node"}).attr("transform",function(d){return"translate("+d.y+","+d.x+")"});nodeUpdate.select("circle").attr("r",6.5).style("fill",function(d){return d._children?"lightsteelblue":"#fff"}),nodeUpdate.select("text").style("fill-opacity",1);var nodeExit=node.exit().transition().duration(duration).attr("transform",function(d){return"translate("+source.y+","+source.x+")"}).attr("class","node").remove();nodeExit.select("circle").attr("r",1e-6),nodeExit.select("text").style("fill-opacity",1e-6);var link=svg.selectAll("path.link").data(links,function(d){return d.target.id}).attr("class",function(d){return widget._leadsToTarget(d.target,source)?"link selected":"link"});link.enter().insert("path","g").attr("class","link").attr("d",function(d){var o={x:source.x0,y:source.y0};return diagonal({source:o,target:o})}),link.transition().duration(duration).attr("d",diagonal),link.exit().transition().duration(duration).attr("d",function(d){var o={x:source.x,y:source.y};return diagonal({source:o,target:o})}).remove(),nodes.forEach(function(d){d.x0=d.x,d.y0=d.y})},click:function(d){this._setupNodeInfo(d),d.id!=root.id&&(d.children?(d._children=d.children,d.children=null):(d.children=d._children,d._children=null)),this.update(d)},selectNode:function(d){$("#"+d.id).trigger("click")},_leadsToTarget:function(d,target){if(d.id==target.id)return!0;if(!(d.children&&d.children.length>0))return!1;for(var x=0,len=d.children.length;x<len;x++)if(this._leadsToTarget(d.children[x],target))return!0},_setupNodeInfo:function(node){$("#title").find("[name='header']").text(node.attributes.statement),$("#title").find("[name='text']").text(node.attributes.details),$("#edit-node").trigger("local.setupEdit",[node]),this._setupNodeComments(node)},_setupNodeComments:function(node){var widget=this;$.ajax({url:"/api/v1/bills/"+this.bill+"/parts/"+this.part+"/nodes/"+node.id+"?include=comments",dataType:"json"}).done(function(json){json.data&&json.data.relationships&&json.data.relationships.comments&&widget._drawNodeComments(json.data.relationships.comments)})},_drawNodeComments:function(comments){var widget=this,container=$("#comment-id-root");container.empty(),$.each(comments,function(index,value){widget._newNodeComment(value,container),$('[data-toggle="tooltip"]').tooltip()}),$(".collapse.panel-body").collapse("show")},_newNodeComment:function(comment,parent){var reply_button=$('<span class="glyphicon glyphicon-comment" aria-hidden="true" style="cursor:pointer" data-toggle="tooltip" data-placement="right" title="reply">&nbsp;</span>'),downvote=$('<span class="glyphicon glyphicon-thumbs-down" aria-hidden="true" style="cursor:pointer" data-toggle="tooltip" data-placement="right" title="vote down">&nbsp;</span>'),upvote=$('<span class="glyphicon glyphicon-thumbs-up" aria-hidden="true" style="cursor:pointer" data-toggle="tooltip" data-placement="right" title="vote up">&nbsp;</span>'),vote=$('<span class="pull-right" style="margin-right:15px;font-size:12px;"></span>').append(comment.attributes.vote+" points");reply_button.bind("click",$.proxy(this._newCommentReply,this));var downvotefunc=$.proxy(function(event){var id=($(event.target),parent.attr("id").split("-"));$.post("/json/vote/comment/"+id[2],"vote=down").done(function(data){upvote.hasClass("uservote")&&upvote.removeClass("uservote"),downvote.addClass("uservote"),vote.empty().append(data.comment.vote+" points"),downvote.unbind("click"),upvote.bind("click",upvotefunc)}).fail(function(){alert("An error occured. You must be logged in to use this function.")})},this),upvotefunc=$.proxy(function(event){var id=($(event.target),parent.attr("id").split("-"));$.post("/json/vote/comment/"+id[2],"vote=up").done(function(data){upvote.addClass("uservote"),downvote.hasClass("uservote")&&downvote.removeClass("uservote"),vote.empty().append(data.comment.vote+" points"),upvote.unbind("click"),downvote.bind("click",downvotefunc)}).fail(function(){alert("An error occured. You must be logged in to use this function.")})},this);comment.uservote>=0&&(comment.attributes.uservote>0&&upvote.addClass("uservote"),downvote.bind("click",downvotefunc)),comment.uservote<=0&&(comment.attributes.uservote<0&&downvote.addClass("uservote"),upvote.bind("click",upvotefunc));var pull=$("<div></div>").addClass("comment-nav");pull.append(upvote),pull.append(downvote),pull.append(reply_button);var top=$('<div id="comment-id-'+comment.id+'"></div>').addClass("panel panel-comment parent-id-"+comment.attributes.parent),heading=$('<div data-toggle="collapse" href="#'+comment.id+'" aria-expanded="true" aria-controls="'+comment.id+'"></div>').addClass("panel-heading"),title=$("<span></span>").addClass("panel-title").append(comment.user).append(vote);heading.append(title),top.append(heading);var body=$('<div id="'+comment.id+'"></div>').addClass("panel-body collapse").append(comment.attributes.text);body.append(pull);var container=parent;top.append(body),container.append(top),comment.children&&comment.children.length>0&&$.each(comment.children,function(index,value){newNodeComment(value,body)})}});