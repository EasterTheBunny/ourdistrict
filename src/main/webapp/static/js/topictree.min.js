/*
* Copyright (C) 2017
*
* This program is free software: you can redistribute it and/or modify
* it under the terms of the GNU General Public License as published by
* the Free Software Foundation, either version 3 of the License, or
* (at your option) any later version.
* 
* This program is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
* GNU General Public License for more details.
* 
* You should have received a copy of the GNU General Public License
* along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
!function($){$.widget("cp.topictree",{options:{depth:20,data:[],size:{w:50,h:50}},_create:function(){var self=this;return this.domain="",this.topic=this.element.attr("topic"),$("body").on("contextmenu","#frame-outer",function(e){return!1}),$.ajax({url:this.domain+"/json/topic/"+this.topic,dataType:"json"}).done(function(json){self.data=json,self._attach()}),this},_attach:function(){this.element.addClass("topictree"),this.width=this.element.width(),this.height=$(window).height()-50,this.stage=new Konva.Stage({container:this.element.attr("id"),width:this.element.width(),height:$(window).height()-50}),this.midpoint={x:this.width/2,y:this.height/2},this.itemSize=this.options.size,this.sortOption="vote",$("#sort-date").on("click",$.proxy(function(){this.sortOption="date",$("#sort-indicator").html("sections sorted by date"),this._redraw(),this._setNode(this.currentNode)},this)),$("#sort-vote").on("click",$.proxy(function(){this.sortOption="vote",$("#sort-indicator").html("sections sorted by vote"),this._redraw(),this._setNode(this.currentNode)},this)),$("#sort-indicator").html("sections sorted by vote"),this.layer=new Konva.Layer,this.linesLayer=new Konva.Layer,this.tipsLayer=new Konva.Layer,this.lineageLayer=new Konva.Layer,this.dragLayer=new Konva.Layer,this._sort(),this._addEvents(),this.currentNode=this.items[this.tiers[0][0]][0],this._setNode(this.currentNode),$(window).resize($.proxy(function(){this._redraw()},this))},_sort:function(){var root="root";this.highvote=0,this.lowvote=1e7;var firstSort={},items={},tiers=[],dataself=this;$.each(this.data,function(index,item){null!=firstSort[item.parent]?firstSort[item.parent].push(item):firstSort[item.parent]=[item],item.vote>dataself.highvote&&(dataself.highvote=item.vote),item.vote<dataself.lowvote&&(dataself.lowvote=item.vote),null!=items[item.id]?items[item.id].push(item):items[item.id]=[item]}),this.items=items;var workingSet=[firstSort[root][0].id];do{var nextSet=[];tiers.push(workingSet),$.each(workingSet,function(index,work){null!=firstSort[work]&&$.each(firstSort[work],function(key,x){$.inArray(x.id,nextSet)==-1&&nextSet.push(x.id)})}),workingSet=nextSet}while(workingSet.length>0);for(var matrix=[],workingTier=tiers.length-1;workingTier>=0;){var nodes=tiers[workingTier],slf=this;$.each(nodes,function(index,node){for(var parent=items[node][0].parent,lineage=[node,parent];null!=items[parent];)parent=items[parent][0].parent,lineage.push(parent);for(var x=[],y=lineage.length-1;y>=0;y--)x.push(lineage[y]);slf._discard(x,matrix)||matrix.push(x)}),workingTier--}for(var sorted=matrix,t=tiers.length;t>=0;t--){var objs={n:[]};$.each(sorted,function(index,sortedElement){var keys=Object.keys(objs);if(null!=sortedElement[t]){var key=sortedElement[t].toString();$.inArray(key,keys)>=0?objs[key].push(sortedElement):objs[key]=[sortedElement]}else objs.n.push(sortedElement)});var sorts=[];$.each(objs,function(key,value){$.merge(sorts,value)}),sorted=sorts}this.sorted=sorted,this.tiers=tiers,this.items=items,this.root=root,this.firstSort=firstSort,this.tooltip=new Konva.Label({opacity:.75,visible:!1,listening:!1}),this.tooltip.add(new Konva.Tag({fill:"black",pointerDirection:"down",pointerWidth:10,pointerHeight:10,lineJoin:"round",shadowColor:"black",shadowBlur:10,shadowOffset:{x:5,y:5},shadowOpacity:.5})),this.tooltip.add(new Konva.Text({text:"",fontFamily:"Calibri",fontSize:18,padding:5,fill:"white"})),this.tipsLayer.add(this.tooltip),this._drawTiers(),this.stage.add(this.linesLayer),this.stage.add(this.layer),this.stage.add(this.lineageLayer),this.stage.add(this.tipsLayer),this.stage.add(this.dragLayer)},_discard:function(array,inarray){var hastwin=!1,haschild=!1;return $.each(inarray,function(index,arg){if(array.length==arg.length){var match=!0;$.each(array,function(ind,elem){arg[ind]!=elem&&(match=!1)}),hastwin||(hastwin=match)}else if(array.length<arg.length){var match=!0;$.each(array,function(ind,elem){arg[ind]!=elem&&(match=!1)}),haschild||(haschild=match)}}),!(!hastwin&&!haschild)},_drawTiers:function(){for(var data=this.sorted,tiers=this.tiers,parentPlacement={},parents={},xpad=25,swidth=1,scolor="#a5a4b3",nodeVertical=this.height/tiers.length,minSpace=(this.width-2*xpad)/data.length;nodeVertical<this.itemSize.h+15;)this.itemSize.h=this.itemSize.h-1;for(;minSpace<this.itemSize.w+20;)this.itemSize.w=this.itemSize.w-1;this.itemSize.w>this.itemSize.h&&(this.itemSize.w=this.itemSize.h),this.itemSize.h>this.itemSize.w&&(this.itemSize.h=this.itemSize.w);for(var growth=(minSpace-this.itemSize.w)/data.length,i=tiers.length;i>0;i--){var drawnNodes=[],count=xpad;parents=parentPlacement,parentPlacement={};var self=this;$.each(parents,function(key,value){if(value.right-value.left<=50){var x=value.left+self.itemSize.w/2,ybottom=i*nodeVertical+self.itemSize.h/2-10,ytop=(i-1)*nodeVertical+self.itemSize.h/2+60,line=new Konva.Line({points:[x,ybottom,x,ytop],tension:1,stroke:scolor,strokeWidth:swidth});self.linesLayer.add(line)}else{var left=value.left+self.itemSize.w/2,right=value.right-self.itemSize.w/2,ybottom=i*nodeVertical+self.itemSize.h/2-10,ymiddle=(i-1)*nodeVertical+self.itemSize.h/2+80,ytop=(i-1)*nodeVertical+self.itemSize.h/2+60,midpoint=(right-left)/2+left,line=new Konva.Line({points:[left,ybottom,left,ymiddle,right,ymiddle,right,ybottom],tension:0,stroke:scolor,strokeWidth:swidth});self.linesLayer.add(line);var line=new Konva.Line({points:[midpoint,ymiddle,midpoint,ytop],tension:0,stroke:scolor,strokeWidth:swidth});self.linesLayer.add(line)}}),$.each(data,function(index,array){if(array.length-1>=i){var node=array[i];if($.inArray(node,drawnNodes)==-1){var xstat=count,ystat=(i-1)*nodeVertical+self.itemSize.h/2;if(void 0!=parents[node.toString()]){var parent=parents[node.toString()];xstat=(parent.right-parent.left)/2+parent.left-self.itemSize.w/2}var pad=0,slf=self,lin=[];i-1>=0&&(lin=array.slice(0,i+1)),"vote"==self.sortOption?self.items[node.toString()].sort(function(a,b){return a.vote<b.vote?-1:a.vote>b.vote?1:0}):"date"==self.sortOption&&self.items[node.toString()].sort(function(a,b){return new Date(a.date)-new Date(b.date)}),$.each(self.items[node.toString()],function(key,value){value.key=key;var red=0,green=100,blue=15;if(slf.highvote-slf.lowvote>0){var vote=Math.floor((value.vote-slf.lowvote)/(slf.highvote-slf.lowvote)*100);vote>=50?(green=100,red=vote):(red=100,green=vote)}var color="rgba("+red+"%,"+green+"%,"+blue+"%,0.8)";color="#DDD";var child=new Konva.Rect({x:xstat+pad,y:ystat,stroke:"#666",strokeWidth:1,fill:color,width:slf.itemSize.w,height:slf.itemSize.h,cornerRadius:5,draggable:!1,shadowColor:"black",shadowBlur:0,shadowOffset:{x:0,y:0},key:value.id,version:value.key});slf.items[value.id][value.key].node=child,slf.items[value.id][value.key].location={x:xstat+pad,y:ystat},slf.items[value.id][value.key].lineage=lin,slf.layer.add(child),pad+=5}),count=xstat,void 0==parentPlacement[self.items[node][0].parent.toString()]?parentPlacement[self.items[node][0].parent.toString()]={left:count,right:count+self.itemSize.w}:parentPlacement[self.items[node][0].parent.toString()].right=count+self.itemSize.w,count+=minSpace+growth}drawnNodes.push(node)}else if(array.length==i){void 0==parentPlacement[array[i-1].toString()]?parentPlacement[array[i-1].toString()]={left:count,right:count+self.itemSize.w}:parentPlacement[array[i-1].toString()].right=count+self.itemSize.w;var xstat=count,ystat=(i-1)*nodeVertical+self.itemSize.h/2,child=new Konva.Rect({x:xstat,y:ystat,stroke:"#CCC",strokeWidth:1,fill:"#fff",width:self.itemSize.w,height:self.itemSize.h,cornerRadius:5});self.layer.add(child),count+=minSpace+growth}else count+=minSpace+growth})}},_redraw:function(){$.each(this.items,$.proxy(function(key,item){$.each(item,$.proxy(function(index,value){value.node=null},this))},this)),this.layer.destroyChildren(),this.linesLayer.destroyChildren(),this.tipsLayer.destroyChildren(),this.lineageLayer.destroyChildren(),this._sort()},_getComments:function(nodeid,version,topic){var self=this;$.ajax({url:this.domain+"/json/comments/"+this.topic+"/"+nodeid+"/"+version,dataType:"json"}).done(function(json){self.comments=json,self._drawComments()})},_drawComments:function(){$("#comment-id-root").empty();var self=this;$.each(this.comments,function(index,value){self._newComment(value),$('[data-toggle="tooltip"]').tooltip()}),$(".collapse.panel-body").collapse("show")},_newComment:function(comment){var reply_button=$('<span class="glyphicon glyphicon-comment" aria-hidden="true" style="cursor:pointer" data-toggle="tooltip" data-placement="right" title="reply">&nbsp;</span>'),downvote=$('<span class="glyphicon glyphicon-thumbs-down" aria-hidden="true" style="cursor:pointer" data-toggle="tooltip" data-placement="right" title="vote down">&nbsp;</span>'),upvote=$('<span class="glyphicon glyphicon-thumbs-up" aria-hidden="true" style="cursor:pointer" data-toggle="tooltip" data-placement="right" title="vote up">&nbsp;</span>'),vote=$('<span class="pull-right" style="margin-right:15px;font-size:12px;"></span>').append(comment.vote+" points");reply_button.bind("click",$.proxy(this._newCommentReply,this));var downvotefunc=$.proxy(function(event){var element=$(event.target),parent=element.parent().parent().parent(),id=parent.attr("id").split("-");$.post(this.domain+"/json/vote/comment/"+id[2],"vote=down").done(function(data){upvote.hasClass("uservote")&&upvote.removeClass("uservote"),downvote.addClass("uservote"),vote.empty().append(data.comment.vote+" points"),downvote.unbind("click"),upvote.bind("click",upvotefunc)}).fail(function(){alert("An error occured. You must be logged in to use this function.")})},this),upvotefunc=$.proxy(function(event){var element=$(event.target),parent=element.parent().parent().parent(),id=parent.attr("id").split("-");$.post(this.domain+"/json/vote/comment/"+id[2],"vote=up").done(function(data){upvote.addClass("uservote"),downvote.hasClass("uservote")&&downvote.removeClass("uservote"),vote.empty().append(data.comment.vote+" points"),upvote.unbind("click"),downvote.bind("click",downvotefunc)}).fail(function(){alert("An error occured. You must be logged in to use this function.")})},this);comment.uservote>=0&&(comment.uservote>0&&upvote.addClass("uservote"),downvote.bind("click",downvotefunc)),comment.uservote<=0&&(comment.uservote<0&&downvote.addClass("uservote"),upvote.bind("click",upvotefunc));var pull=$("<div></div>").addClass("comment-nav");pull.append(upvote),pull.append(downvote),pull.append(reply_button);var top=$('<div id="comment-id-'+comment.id+'"></div>').addClass("panel panel-comment parent-id-"+comment.parent),heading=$('<div data-toggle="collapse" href="#'+comment.id+'" aria-expanded="true" aria-controls="'+comment.id+'"></div>').addClass("panel-heading"),title=$("<span></span>").addClass("panel-title").append(comment.user).append(vote);heading.append(title),top.append(heading);var body=$('<div id="'+comment.id+'"></div>').addClass("panel-body collapse").append(comment.text);body.append(pull);var container="";if($(".parent-id-"+comment.id).size()>0&&body.append($(".parent-id-"+comment.id)),$("#comment-id-"+comment.parent).size()>0){container=$("#comment-id-"+comment.parent);var cnt=container.children(".panel-body");cnt.length>=1&&(container=cnt)}else container=$("#comment-id-root");top.append(body),container.append(top)},_mouseover:function(evt){var shape=evt.target;if(shape){if(shape.setOpacity(.75),shape.getAttr("key")){var str=this.items[shape.getAttr("key")][shape.getAttr("version")].statement;str+="\n",str=str+"version: "+(shape.getAttr("version")+1),str+="\n",str=str+"id: "+shape.getAttr("key"),str="Click for more details.",this._updateToolTip(str,shape.position().x+this.itemSize.w/2,shape.position().y),this.tipsLayer.batchDraw()}this.layer.draw()}},_mouseout:function(evt){var shape=evt.target;shape&&(shape.opacity(1),this.tooltip.hide(),this.tipsLayer.draw(),this.layer.draw())},_mouseclick:function(evt){var node=evt.target;console.log(evt),node&&this._setNode(this.items[node.getAttr("key")][node.getAttr("version")])},_dragstart:function(event){var shape=event.target;shape.moveTo(this.dragLayer),this.stage.draw(),this.reposition={x:shape.getAttr("x"),y:shape.getAttr("y")},shape.setAttrs({shadowOffset:{x:5,y:5}})},_dragend:function(event){var shape=event.target;shape.moveTo(this.layer),this.stage.draw();this.reposition;shape.setAttrs({x:this.reposition.x,y:this.reposition.y,shadowOffset:{x:0,y:0}}),this.layer.draw()},_setNode:function(target){this.currentTarget&&this.currentTarget.fill("#DDD"),this.currentTarget=target.node,target.node.fill("#333");var loc="";$.each(target.lineage,$.proxy(function(index,value){"root"!=value&&(loc.length>0&&(loc+=";"),loc=loc+value+":"+this.items[value][0].version)},this)),this.currentNode=target;var downvote=$('<span id="node-downvote" class="glyphicon glyphicon-thumbs-down" aria-hidden="true" style="cursor:pointer" data-toggle="tooltip" data-placement="right" title="vote down">&nbsp;</span>'),upvote=$('<span id="node-upvote" class="glyphicon glyphicon-thumbs-up" aria-hidden="true" style="cursor:pointer" data-toggle="tooltip" data-placement="right" title="vote up">&nbsp;</span>'),vote=$('<span id="node-interest-value" style="margin-right:15px;font-size:12px;"></span>').append(target.vote),pull=$("<div></div>"),downvotefunc=$.proxy(function(event){$(event.target);$.post(this.domain+"/json/vote/node/"+this.currentNode.id,"vote=down").done(function(data){$("#node-interest-value").empty().append(data.node.vote),$("#node-upvote").toggleClass("uservote"),$("#node-downvote").toggleClass("uservote"),downvote.unbind("click"),upvote.bind("click",upvotefunc)}).fail(function(){alert("An error occured. You must be logged in to use this function.")})},this),upvotefunc=$.proxy(function(event){$(event.target);$.post(this.domain+"/json/vote/node/"+this.currentNode.id,"vote=up").done(function(data){$("#node-interest-value").empty().append(data.node.vote),$("#node-upvote").toggleClass("uservote"),$("#node-downvote").toggleClass("uservote"),upvote.unbind("click"),downvote.bind("click",downvotefunc)}).fail(function(){alert("An error occured. You must be logged in to use this function.")})},this);this.currentNode.uservote>=0&&(downvote.bind("click",downvotefunc),this.currentNode.uservote>0&&upvote.addClass("uservote")),this.currentNode.uservote<=0&&(upvote.bind("click",upvotefunc),this.currentNode.uservote<0&&downvote.addClass("uservote")),pull.append(vote),pull.append(upvote),pull.append(downvote),$("#pdf-section").attr("href","/pdf/node/"+target.id+".pdf"),$("#pdf-comments").attr("href","/pdf/comments/"+target.id+".pdf"),$("#pdf-document").attr("href","/pdf/topic/"+this.topic+".pdf?node-list="+loc),$("#current-node-id").val(target.id),$("#version-node-id").value=target.id,$("#node-details-title").empty(),$("#node-details-title").append(target.statement),$("#node-details-owner").empty(),$("#node-details-owner").append(target.user),$("#node-details-version").empty(),$("#node-details-version").append(target.version),$("#node-details-text").empty(),$("#node-details-text").append(target.details),$("#node-details-interest").empty(),$("#node-details-interest").append(pull),$('input[name="current-node-id"]').val(target.id),$('input[name="current-topic-id"]').val(this.topic),$("#new-comment-form :input[name='current-node-version']").val(target.version),$("#new-comment-form :input[name='current-comment-id']").val("root"),$("#new-comment-form :input[name='new-comment-text']").val(""),this._getComments(target.id,target.version,this.topic),this.lineageLayer.removeChildren(),$.each(target.lineage,$.proxy(function(index,value){if(index-1>0){var parentLoc=this.items[target.lineage[index-1]][0].location,loc=this.items[value][0].location,xmid=this.itemSize.w/2,ymid=this.itemSize.h/2,line=new Konva.Line({points:[loc.x+xmid,loc.y+ymid,parentLoc.x+xmid,parentLoc.y+ymid],tension:0,stroke:"#000",strokeWidth:1});this.lineageLayer.add(line)}},this)),this.lineageLayer.batchDraw(),this.layer.batchDraw()},_updateToolTip:function(text,x,y){this.tooltip.getText().text(text),this.tooltip.position({x:x,y:y}),this.tooltip.show()},_addEvents:function(){var stage=this.stage;stage.on("mouseover",$.proxy(this._mouseover,this)),stage.on("mouseout",$.proxy(this._mouseout,this)),stage.on("click",$.proxy(this._mouseclick,this)),stage.on("dragstart",$.proxy(this._dragstart,this)),stage.on("dragend",$.proxy(this._dragend,this))},_newCommentReply:function(event){var element=$(event.target),parent=element.parent().parent().parent(),body=parent.children(".panel-body"),form=$("<form></form>"),group1=$('<div class="form-group"></div>'),input=$('<textarea class="form-control" rows="3" name="new-comment-text" placeholder="comment"></textarea>'),id=parent.attr("id").split("-"),hidden1=$('<input type="hidden" value="" name="current-comment-id">').val(id[2]);console.log(this.topic);var hidden2=$('<input type="hidden" value="" name="current-topic-id">').val(this.topic),hidden3=$('<input type="hidden" value="" name="current-node-version">').val(this.currentNode.version),hidden4=$('<input type="hidden" value="" name="current-node-id">').val(this.currentNode.id),group2=$('<div class="form-group"></div>'),cancel=$('<button type="button" class="btn btn-default">Cancel</button>'),submit=$('<button type="button" class="btn btn-primary pull-right">Reply</button>');form.append(hidden1),form.append(hidden2),form.append(hidden3),form.append(hidden4),group1.append(input),form.append(group1),group2.append(cancel),group2.append(submit),form.append(group2),form.prependTo(body),cancel.click(form,function(event){event.data.remove()}),submit.click(form,$.proxy(function(event){var self=this;$.post(this.domain+"/json/add/comment",event.data.serialize()).done(function(data){self.comments.push(data.comment),self._newComment(data.comment),event.data.remove()}).fail(function(){event.data.remove(),alert("An error occured. You must be logged in to use this function.")})},this))},_submitNewNode:function(){var self=this;$.post(this.domain+"/json/add/node",$("#new-node-form").serialize()).done(function(data){self.data.push(data.node),self.currentNode=self.items[data.node.id][0],self._redraw(),$("#section-info li:eq(0) a").tab("show"),$("#new-comment-form :input[name='new-node-statement']").val(""),$("#new-comment-form :input[name='new-node-details']").val("")}).fail(function(){alert("An error occured. You must be logged in to use this function.")})},_submitNewVersion:function(){var self=this;$.post(this.domain+"/json/add/version",$("#new-version-form").serialize()).done(function(data){self.data.push(data.node),self.currentNode=self.items[data.node.id][data.node.version],self._redraw(),$("#section-info li:eq(0) a").tab("show")}).fail(function(){alert("An error occured. You must be logged in to use this function.")})},_submitNewComment:function(){var self=this;$.post(this.domain+"/json/add/comment",$("#new-comment-form").serialize()).done(function(data){self.comments.push(data.comment),self._getComments($("#new-comment-form :input[name='current-node-id']").val(),$("#new-comment-form :input[name='current-node-version']").val(),1),$("#section-info li:eq(1) a").tab("show"),$("#new-comment-form :input[name='new-comment-text']").val("")}).fail(function(){alert("An error occured. You must be logged in to use this function.")})}})}(jQuery);